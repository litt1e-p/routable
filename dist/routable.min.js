"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports[Symbol.toStringTag]="Module";var S=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function Q(t){return Array.prototype.slice.call(t)}function N(t){return new Promise(function(i,r){t.onsuccess=function(){i(t.result)},t.onerror=function(){r(t.error)}})}function R(t,i,r){var s,c=new Promise(function(u,o){N(s=t[i].apply(t,r)).then(u,o)});return c.request=s,c}function X(t,i,r){var s=R(t,i,r);return s.then(function(c){if(c)return new I(c,s.request)})}function P(t,i,r){r.forEach(function(s){Object.defineProperty(t.prototype,s,{get:function(){return this[i][s]},set:function(c){this[i][s]=c}})})}function K(t,i,r,s){s.forEach(function(c){c in r.prototype&&(t.prototype[c]=function(){return R(this[i],c,arguments)})})}function A(t,i,r,s){s.forEach(function(c){c in r.prototype&&(t.prototype[c]=function(){return this[i][c].apply(this[i],arguments)})})}function V(t,i,r,s){s.forEach(function(c){c in r.prototype&&(t.prototype[c]=function(){return X(this[i],c,arguments)})})}function j(t){this._index=t}function I(t,i){this._cursor=t,this._request=i}function b(t){this._store=t}function x(t){this._tx=t,this.complete=new Promise(function(i,r){t.oncomplete=function(){i()},t.onerror=function(){r(t.error)},t.onabort=function(){r(t.error)}})}function D(t,i,r){this._db=t,this.oldVersion=i,this.transaction=new x(r)}function B(t){this._db=t}if(function(t){var i,r,s,c,u;if(s=t.IDBObjectStore||t.webkitIDBObjectStore||t.mozIDBObjectStore||t.msIDBObjectStore,r=t.IDBIndex||t.webkitIDBIndex||t.mozIDBIndex||t.msIDBIndex,s!==void 0&&r!==void 0){var o=!1;typeof WorkerGlobalScope!="undefined"&&(navigator.userAgent.indexOf("Safari/602")>=0||navigator.userAgent.indexOf("Safari/603")>=0)&&(o=!0),(o||s.prototype.getAll===void 0||r.prototype.getAll===void 0||s.prototype.getAllKeys===void 0||r.prototype.getAllKeys===void 0)&&(c=function(){this.result=null,this.error=null,this.source=null,this.transaction=null,this.readyState="pending",this.onsuccess=null,this.onerror=null,this.toString=function(){return"[object IDBRequest]"},this._listeners={success:[],error:[]};var a=this;this.addEventListener=function(n,l){a._listeners[n]&&a._listeners[n].push(l)},this.removeEventListener=function(n,l){a._listeners[n]&&(a._listeners[n]=a._listeners[n].filter(function(f){return l!==f}))}},i=function(a){this.type=a,this.target=null,this.currentTarget=null,this.NONE=0,this.CAPTURING_PHASE=1,this.AT_TARGET=2,this.BUBBLING_PHASE=3,this.eventPhase=this.NONE,this.stopPropagation=function(){console.log("stopPropagation not implemented in IndexedDB-getAll-shim")},this.stopImmediatePropagation=function(){console.log("stopImmediatePropagation not implemented in IndexedDB-getAll-shim")},this.bubbles=!1,this.cancelable=!1,this.preventDefault=function(){console.log("preventDefault not implemented in IndexedDB-getAll-shim")},this.defaultPrevented=!1,this.isTrusted=!1,this.timestamp=Date.now()},u=function(a,n){return function(l,f){var p,h,d;return l=l!==void 0?l:null,h=new c,d=[],(p=this.openCursor(l)).onsuccess=function(v){var _,w,E,q;if((_=v.target.result)&&(q=n==="value"?_.value:a==="index"?_.primaryKey:_.key,d.push(q),f===void 0||d.length<f))_.continue();else if(h.result=d,(w=new i("success")).target={readyState:"done",result:d},typeof h.onsuccess=="function"&&h.onsuccess(w),h._listeners.success.length>0)for(E=0;E<h._listeners.success.length;E++)h._listeners.success[E](w)},p.onerror=function(v){var _;if(console.log("IndexedDB-getAll-shim error when getting data:",v.target.error),typeof h.onerror=="function"&&h.onerror(v),h._listeners.error.length>0)for(_=0;_<h._listeners.error.length;_++)h._listeners.error[_](e)},h}},(o||s.prototype.getAll===void 0)&&(s.prototype.getAll=u("objectStore","value")),(o||r.prototype.getAll===void 0)&&(r.prototype.getAll=u("index","value")),(o||s.prototype.getAllKeys===void 0)&&(s.prototype.getAllKeys=u("objectStore","key")),(o||r.prototype.getAllKeys===void 0)&&(r.prototype.getAllKeys=u("index","key")))}}(typeof window!="undefined"?window:typeof WorkerGlobalScope!="undefined"?self:S!==void 0?S:Function("return this;")()),P(j,"_index",["name","keyPath","multiEntry","unique"]),K(j,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),V(j,"_index",IDBIndex,["openCursor","openKeyCursor"]),P(I,"_cursor",["direction","key","primaryKey","value"]),K(I,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(t){t in IDBCursor.prototype&&(I.prototype[t]=function(){var i=this,r=arguments;return Promise.resolve().then(function(){return i._cursor[t].apply(i._cursor,r),N(i._request).then(function(s){if(s)return new I(s,i._request)})})})}),b.prototype.createIndex=function(){return new j(this._store.createIndex.apply(this._store,arguments))},b.prototype.index=function(){return new j(this._store.index.apply(this._store,arguments))},P(b,"_store",["name","keyPath","indexNames","autoIncrement"]),K(b,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),V(b,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),A(b,"_store",IDBObjectStore,["deleteIndex"]),x.prototype.objectStore=function(){return new b(this._tx.objectStore.apply(this._tx,arguments))},P(x,"_tx",["objectStoreNames","mode"]),A(x,"_tx",IDBTransaction,["abort"]),D.prototype.createObjectStore=function(){return new b(this._db.createObjectStore.apply(this._db,arguments))},P(D,"_db",["name","version","objectStoreNames"]),A(D,"_db",IDBDatabase,["deleteObjectStore","close"]),B.prototype.transaction=function(){return new x(this._db.transaction.apply(this._db,arguments))},P(B,"_db",["name","version","objectStoreNames"]),A(B,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(t){[b,j].forEach(function(i){t in i.prototype&&(i.prototype[t.replace("open","iterate")]=function(){var r=Q(arguments),s=r[r.length-1],c=this._store||this._index,u=c[t].apply(c,r.slice(0,-1));u.onsuccess=function(){s(u.result)}})})}),[j,b].forEach(function(t){t.prototype.getAll||(t.prototype.getAll=function(i,r){var s=this,c=[];return new Promise(function(u){s.iterateCursor(i,function(o){o?(c.push(o.value),r===void 0||c.length!=r?o.continue():u(c)):u(c)})})})}),[j,b].forEach(function(t){t.prototype.getAllKeys||(t.prototype.getAllKeys=function(i,r){var s=this,c=[];return new Promise(function(u){s.iterateCursor(i,function(o){o?(c.push(o.key),r===void 0||c.length!=r?o.continue():u(c)):u(c)})})})}),!("indexedDB"in window))throw new Error("Fatal error: the browser does not support indexedDb");const y="__rtb_db_table",O=(L=t=>{t.createObjectStore(y)},C=R(indexedDB,"open",["__rtb_db_routable",1]),(U=C.request)&&(U.onupgradeneeded=function(t){L&&L(new D(U.result,t.oldVersion,U.transaction))}),C.then(function(t){return new B(t)}));var L,C,U,g={async __rtb_setSS(t,i){const r=(await O).transaction(y,"readwrite");return r.objectStore(y).put(i,t),r.complete},__rtb_getSS:async t=>(await O).transaction(y).objectStore(y).get(t),async __rtb_delSS(t){const i=(await O).transaction(y,"readwrite");return i.objectStore(y).delete(t),i.complete},async __rtb_clearSS(){const t=(await O).transaction(y,"readwrite");return t.objectStore(y).clear(),t.complete},__rtb_ssKeys:async()=>(await O).transaction(y).objectStore(y).getAllKeys(),__rtb_ssVals:async()=>(await O).transaction(y).objectStore(y).getAll()},m={_gen:function(t=32){return this._ren(new Date().getTime().toString(t))},_ren:function(t){if(!t||!t.length)return t;let i=t.split(""),r=[];for(;i.length;){let s=i.shift();r.unshift(Math.random()>.6?s.toUpperCase():s)}return r.join("")},_enc:function(t,i,r="."){return t+i.split("").reverse().join(r)},_dec:function(t,i,r="."){return t+this._enb(i.slice(t.length).split(r).reverse().join(""))},_enp:function(t){return btoa(encodeURIComponent(JSON.stringify(t)))},_dep:function(t){return JSON.parse(decodeURIComponent(atob(t)))},_enb:function(t){return btoa(t)},_deb:function(t){return atob(t)}};(function(t){var i=function(){try{return!!Symbol.iterator}catch{return!1}}(),r=function(o){var a={next:function(){var n=o.shift();return{done:n===void 0,value:n}}};return i&&(a[Symbol.iterator]=function(){return a}),a},s=function(o){return encodeURIComponent(o).replace(/%20/g,"+")},c=function(o){return decodeURIComponent(String(o).replace(/\+/g," "))};(function(){try{var o=t.URLSearchParams;return new o("?a=1").toString()==="a=1"&&typeof o.prototype.set=="function"&&typeof o.prototype.entries=="function"}catch{return!1}})()||function(){var o=function(n){Object.defineProperty(this,"_entries",{writable:!0,value:{}});var l=typeof n;if(l!=="undefined")if(l==="string")n!==""&&this._fromString(n);else if(n instanceof o){var f=this;n.forEach(function(v,_){f.append(_,v)})}else{if(n===null||l!=="object")throw new TypeError("Unsupported input's type for URLSearchParams");if(Object.prototype.toString.call(n)==="[object Array]")for(var p=0;p<n.length;p++){var h=n[p];if(Object.prototype.toString.call(h)!=="[object Array]"&&h.length===2)throw new TypeError("Expected [string, any] as entry at index "+p+" of URLSearchParams's input");this.append(h[0],h[1])}else for(var d in n)n.hasOwnProperty(d)&&this.append(d,n[d])}},a=o.prototype;a.append=function(n,l){n in this._entries?this._entries[n].push(String(l)):this._entries[n]=[String(l)]},a.delete=function(n){delete this._entries[n]},a.get=function(n){return n in this._entries?this._entries[n][0]:null},a.getAll=function(n){return n in this._entries?this._entries[n].slice(0):[]},a.has=function(n){return n in this._entries},a.set=function(n,l){this._entries[n]=[String(l)]},a.forEach=function(n,l){var f;for(var p in this._entries)if(this._entries.hasOwnProperty(p)){f=this._entries[p];for(var h=0;h<f.length;h++)n.call(l,f[h],p,this)}},a.keys=function(){var n=[];return this.forEach(function(l,f){n.push(f)}),r(n)},a.values=function(){var n=[];return this.forEach(function(l){n.push(l)}),r(n)},a.entries=function(){var n=[];return this.forEach(function(l,f){n.push([f,l])}),r(n)},i&&(a[Symbol.iterator]=a.entries),a.toString=function(){var n=[];return this.forEach(function(l,f){n.push(s(f)+"="+s(l))}),n.join("&")},t.URLSearchParams=o}();var u=t.URLSearchParams.prototype;typeof u.sort!="function"&&(u.sort=function(){var o=this,a=[];this.forEach(function(l,f){a.push([f,l]),o._entries||o.delete(f)}),a.sort(function(l,f){return l[0]<f[0]?-1:l[0]>f[0]?1:0}),o._entries&&(o._entries={});for(var n=0;n<a.length;n++)this.append(a[n][0],a[n][1])}),typeof u._fromString!="function"&&Object.defineProperty(u,"_fromString",{enumerable:!1,configurable:!1,writable:!1,value:function(o){if(this._entries)this._entries={};else{var a=[];this.forEach(function(p,h){a.push(h)});for(var n=0;n<a.length;n++)this.delete(a[n])}var l,f=(o=o.replace(/^\?/,"")).split("&");for(n=0;n<f.length;n++)l=f[n].split("="),this.append(c(l[0]),l.length>1?c(l[1]):"")}})})(S!==void 0?S:typeof window!="undefined"?window:typeof self!="undefined"?self:S),function(t){if(function(){try{var r=new t.URL("b","http://a");return r.pathname="c d",r.href==="http://a/c%20d"&&r.searchParams}catch{return!1}}()||function(){var r=t.URL,s=function(u,o){typeof u!="string"&&(u=String(u)),o&&typeof o!="string"&&(o=String(o));var a,n=document;if(o&&(t.location===void 0||o!==t.location.href)){o=o.toLowerCase(),(a=(n=document.implementation.createHTMLDocument("")).createElement("base")).href=o,n.head.appendChild(a);try{if(a.href.indexOf(o)!==0)throw new Error(a.href)}catch(w){throw new Error("URL unable to set base "+o+" due to "+w)}}var l=n.createElement("a");l.href=u,a&&(n.body.appendChild(l),l.href=l.href);var f=n.createElement("input");if(f.type="url",f.value=u,l.protocol===":"||!/:/.test(l.href)||!f.checkValidity()&&!o)throw new TypeError("Invalid URL");Object.defineProperty(this,"_anchorElement",{value:l});var p=new t.URLSearchParams(this.search),h=!0,d=!0,v=this;["append","delete","set"].forEach(function(w){var E=p[w];p[w]=function(){E.apply(p,arguments),h&&(d=!1,v.search=p.toString(),d=!0)}}),Object.defineProperty(this,"searchParams",{value:p,enumerable:!0});var _=void 0;Object.defineProperty(this,"_updateSearchParams",{enumerable:!1,configurable:!1,writable:!1,value:function(){this.search!==_&&(_=this.search,d&&(h=!1,this.searchParams._fromString(this.search),h=!0))}})},c=s.prototype;["hash","host","hostname","port","protocol"].forEach(function(u){(function(o){Object.defineProperty(c,o,{get:function(){return this._anchorElement[o]},set:function(a){this._anchorElement[o]=a},enumerable:!0})})(u)}),Object.defineProperty(c,"search",{get:function(){return this._anchorElement.search},set:function(u){this._anchorElement.search=u,this._updateSearchParams()},enumerable:!0}),Object.defineProperties(c,{toString:{get:function(){var u=this;return function(){return u.href}}},href:{get:function(){return this._anchorElement.href.replace(/\?$/,"")},set:function(u){this._anchorElement.href=u,this._updateSearchParams()},enumerable:!0},pathname:{get:function(){return this._anchorElement.pathname.replace(/(^\/?)/,"/")},set:function(u){this._anchorElement.pathname=u},enumerable:!0},origin:{get:function(){var u={"http:":80,"https:":443,"ftp:":21}[this._anchorElement.protocol],o=this._anchorElement.port!=u&&this._anchorElement.port!=="";return this._anchorElement.protocol+"//"+this._anchorElement.hostname+(o?":"+this._anchorElement.port:"")},enumerable:!0},password:{get:function(){return""},set:function(u){},enumerable:!0},username:{get:function(){return""},set:function(u){},enumerable:!0}}),s.createObjectURL=function(u){return r.createObjectURL.apply(r,arguments)},s.revokeObjectURL=function(u){return r.revokeObjectURL.apply(r,arguments)},t.URL=s}(),t.location!==void 0&&!("origin"in t.location)){var i=function(){return t.location.protocol+"//"+t.location.hostname+(t.location.port?":"+t.location.port:"")};try{Object.defineProperty(t.location,"origin",{get:i,enumerable:!0})}catch{setInterval(function(){t.location.origin=i()},100)}}}(S!==void 0?S:typeof window!="undefined"?window:typeof self!="undefined"?self:S);const k=(t,i)=>g.__rtb_setSS(t,i),G=t=>g.__rtb_getSS(t),M=(t,i=!1,r=32,s="sl,",c="gs_l")=>{if(!t||t.length<=0)return"";if(!i){let a=Object.prototype.constructor();return a[c]=m._enp(t),a}const u=m._gen(r);k(s+m._enb(u),m._enp(t));let o=Object.prototype.constructor();return o[c]=m._enc(s,u),o},H=async(t,i=!1,r="sl,",s="gs_l")=>{if(!t||Object.keys(t).length<=0||!t.hasOwnProperty(s))return{};if(!i)return m._dep(t[s]);if(!t[s].includes(r))return{};let c=await g.__rtb_getSS(m._dec(r,t[s])).catch(u=>!1);return c?m._dep(c):{}},z=async(t,i="sl,",r="gs_l")=>{let s=!1,c=t&&t.hasOwnProperty(r)?t[r]:void 0;if(!c)return s;let u=await g.__rtb_ssKeys(),o=u.length;if(!o)return s;for(let a=0;a<o;a++){const n=u[a];if(c&&J(n)&&n===m._dec(i,c)){g.__rtb_delSS(n),s=!0;break}}return s},F=async(t="",i="sl,",r="gs_l")=>{let s=await g.__rtb_ssKeys(),c=s.length;if(!c)return!0;let u,o=t?await g.__rtb_getSS(t):"";if(o){const a=await T(o);a.hasOwnProperty("query")&&a.query.hasOwnProperty(r)&&(u=m._dec(i,a.query[r]))}for(let a=0;a<c;a++){const n=s[a];J(n)&&u!==n&&g.__rtb_delSS(n)}return!0},J=(t,i="sl,")=>Object.prototype.toString.call(t)==="[object String]"&&t.length>=3&&t.slice(0,3)===i,W=async()=>await g.__rtb_ssKeys(),$=async()=>await g.__rtb_ssVals(),T=(t="")=>new Promise((i,r)=>{if(!t||typeof t!="string")return r(new Error("Invalid __rtb_route params"));if("URLSearchParams"in window){const c=new URL(t),u=(s=new URLSearchParams(c.search),typeof Object.fromEntries=="function"?Object.fromEntries(s):[...s].reduce((o,[a,n])=>(o[a]=n,o),{}));return i({path:c.pathname,query:u})}return r(new Error("Browser does not supports URLSearchParams"));var s}),Y={__rtb_erase:M,__rtb_record:H,__rtb_flush:z,__rtb_clear:F,__rtb_set:k,__rtb_get:G,__rtb_allKeys:W,__rtb_allVals:$,__rtb_route:T};exports.__rtb_allKeys=W,exports.__rtb_allVals=$,exports.__rtb_clear=F,exports.__rtb_erase=M,exports.__rtb_flush=z,exports.__rtb_get=G,exports.__rtb_record=H,exports.__rtb_route=T,exports.__rtb_set=k,exports.default=Y;
